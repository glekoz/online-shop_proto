syntax = "proto3";

import "google/protobuf/wrappers.proto";

option go_package = "github.com/glekoz/online-shop_proto/image";

// Для UploadImageRequest можно ещё добавить idempodency key, чтобы различать, какие изображения были успешно обработаны,
// а какие, возможно, стоит ретраить (gRPC retry) из-за сетевой ошибки

service Image {
    rpc CreateEntity(CreateEntityRequest) returns (BoolResponse);
    rpc DeleteEntity(CommonMetadata) returns (BoolResponse);
    rpc IsStatusFree(CommonMetadata) returns (BoolResponse);
    rpc UploadImage(stream UploadImageRequest) returns (stream UploadImageResponse);
    rpc DeleteImage(DeleteImageRequest) returns (DeleteImageResponse);
    rpc GetCoverImage(CommonMetadata) returns (GetCoverImageResponse);
    rpc GetImageList(CommonMetadata) returns (GetImageListResponse);
}

message CommonMetadata {
    string service = 1;
    string entity_id = 2;
}


message UploadImageRequest {
    oneof data {
        CommonMetadata metadata = 1;
        bytes image_chunk = 2;
        //bool is_cover = 3;
        google.protobuf.BoolValue is_cover = 3;
    }
}

message UploadImageResponse {
    string image_id = 1;
    string err = 2;
}


message DeleteImageRequest {
    CommonMetadata common_metadata = 1;
    repeated string image_path= 2;
}

message DeleteImageResponse {
    repeated UploadImageResponse resp = 1;
}


message BoolResponse {
    bool ok = 1;
}


message CreateEntityRequest {
    CommonMetadata common_metadata = 1;
    int32 max_count= 2;
}


message DeleteEntityRequest {
    CommonMetadata common_metadata = 1;
}


message GetCoverImageResponse {
    string cover_image_path = 1;
}


message GetImageListResponse {
    repeated string image_path = 1;
}

// protoc -I ./proto --go_out ./protoimage --go-grpc_out ./protoimage --go_opt paths=source_relative --go-grpc_opt paths=source_relative .\proto\image.proto